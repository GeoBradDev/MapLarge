<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>File Browser</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 2rem;
        }

        h2 {
            margin-bottom: 0.5rem;
        }

        ul {
            list-style: none;
            padding-left: 0;
        }

        li {
            margin: 0.25rem 0;
            cursor: pointer;
        }

        li:hover {
            text-decoration: underline;
        }

        .folder {
            font-weight: bold;
        }
    </style>
</head>
<body>
<p id="summary"></p>
<h2 id="path-title">ðŸ“‚ /</h2>
<form id="uploadForm" enctype="multipart/form-data">
    <input type="file" id="fileInput" name="file" required/>
    <button type="submit">Upload</button>
</form>

<ul id="file-list"></ul>

<!--
This script fetches and displays file/folder listings from the ASP.NET API.
    It supports deep-link navigation, uploads via form, and file deletion via buttons.
-->
<script>
    // Fetch and render contents of the given path
    // Updates UI with clickable folders and delete buttons
    async function fetchAndRender(path = '') {
        const response = await fetch(`/api/browse/${encodeURIComponent(path)}`);
        const list = document.getElementById('file-list');
        const title = document.getElementById('path-title');
        const summary = document.getElementById('summary');

        if (!response.ok) {
            list.innerHTML = `<li style="color:red;">Failed to load folder: ${path}</li>`;
            summary.textContent = '';
            return;
        }

        const items = await response.json();

        const fileCount = items.filter(i => i.type === 'file').length;
        const folderCount = items.filter(i => i.type === 'folder').length;
        const totalSize = items
            .filter(i => i.size != null)
            .reduce((sum, i) => sum + i.size, 0);

        summary.textContent = `ðŸ“ ${folderCount} folders, ðŸ“„ ${fileCount} files, ðŸ“¦ ${totalSize} bytes`;
        title.textContent = `ðŸ“‚ /${path}`;
        list.innerHTML = '';


        if (path) {
            const parentPath = path.split('/').slice(0, -1).join('/');
            const upPath = parentPath || '';
            const upEntry = document.createElement('li');
            upEntry.className = 'folder';
            upEntry.textContent = 'â¬…ï¸ ..';
            upEntry.onclick = () => goTo(upPath);
            list.appendChild(upEntry);
        }

        for (const item of items) {
            const entry = document.createElement('li');
            entry.textContent = `${item.type === 'folder' ? 'ðŸ“' : 'ðŸ“„'} ${item.name}${item.size != null ? ` (${item.size} bytes)` : ''}`;
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'ðŸ—‘ï¸';
            deleteBtn.style.marginLeft = '1rem';
            deleteBtn.onclick = async (e) => {
                e.stopPropagation();
                if (!confirm(`Delete "${item.name}"?`)) return;

                const targetPath = path ? `${path}/${item.name}` : item.name;
                const res = await fetch(`/api/browse/delete/${encodeURIComponent(targetPath)}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    fetchAndRender(path);
                } else {
                    const err = await res.text();
                    alert('Delete failed: ' + err);
                }
            };

            entry.appendChild(deleteBtn);

            if (item.type === 'folder') {
                entry.onclick = () => goTo(path ? `${path}/${item.name}` : item.name);
            }
            list.appendChild(entry);
        }
    }

    function goTo(path) {
        location.hash = encodeURIComponent(path);
    }

    window.addEventListener('hashchange', () => {
        const path = decodeURIComponent(location.hash.slice(1));
        fetchAndRender(path);
    });

    fetchAndRender(decodeURIComponent(location.hash.slice(1)));
</script>
<script>
    // Handles file upload form submission
    // Sends the selected file to the backend API
    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const file = document.getElementById('fileInput').files[0];
        if (!file) return;

        const path = decodeURIComponent(location.hash.slice(1));
        const formData = new FormData();
        formData.append('file', file);

        const res = await fetch(`/api/browse/upload/${path}`, {
            method: 'POST',
            body: formData
        });

        if (res.ok) {
            alert('File uploaded successfully!');
            document.getElementById('fileInput').value = '';
            fetchAndRender(path);
        } else {
            const error = await res.text();
            alert('Upload failed: ' + error);
        }
    });

</script>
</body>
</html>
