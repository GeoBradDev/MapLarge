<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>File Browser</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 2rem;
        }

        h2 {
            margin-bottom: 0.5rem;
        }

        ul {
            list-style: none;
            padding-left: 0;
        }

        li {
            margin: 0.25rem 0;
            cursor: pointer;
        }

        li:hover {
            text-decoration: underline;
        }

        .folder {
            font-weight: bold;
        }
    </style>
</head>
<body>
<p id="summary"></p>
<h2 id="path-title">üìÇ /</h2>
<form id="uploadForm" enctype="multipart/form-data">
    <input type="file" id="fileInput" name="file" required/>
    <button type="submit">Upload</button>
</form>

<ul id="file-list"></ul>

<script>
    async function fetchAndRender(path = '') {
        const response = await fetch(`/api/browse/${encodeURIComponent(path)}`);
        const list = document.getElementById('file-list');
        const title = document.getElementById('path-title');
        const summary = document.getElementById('summary');

        if (!response.ok) {
            list.innerHTML = `<li style="color:red;">Failed to load folder: ${path}</li>`;
            summary.textContent = '';
            return;
        }

        const items = await response.json();

        const fileCount = items.filter(i => i.type === 'file').length;
        const folderCount = items.filter(i => i.type === 'folder').length;
        const totalSize = items
            .filter(i => i.size != null)
            .reduce((sum, i) => sum + i.size, 0);

        summary.textContent = `üìÅ ${folderCount} folders, üìÑ ${fileCount} files, üì¶ ${totalSize} bytes`;
        title.textContent = `üìÇ /${path}`;
        list.innerHTML = '';


        if (path) {
            const parentPath = path.split('/').slice(0, -1).join('/');
            const upPath = parentPath || '';
            list.innerHTML += `<li class="folder" onclick="goTo('${upPath}')">‚¨ÖÔ∏è ..</li>`;
        }

        for (const item of items) {
            const entry = document.createElement('li');
            entry.textContent = `${item.type === 'folder' ? 'üìÅ' : 'üìÑ'} ${item.name}${item.size != null ? ` (${item.size} bytes)` : ''}`;
            if (item.type === 'folder') {
                entry.onclick = () => goTo(path ? `${path}/${item.name}` : item.name);
            }
            list.appendChild(entry);
        }
    }

    function goTo(path) {
        location.hash = encodeURIComponent(path);
    }

    window.addEventListener('hashchange', () => {
        const path = decodeURIComponent(location.hash.slice(1));
        fetchAndRender(path);
    });

    // Load initial path
    fetchAndRender(decodeURIComponent(location.hash.slice(1)));
</script>
<script>
    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const file = document.getElementById('fileInput').files[0];
        if (!file) return;

        const path = decodeURIComponent(location.hash.slice(1));
        const formData = new FormData();
        formData.append('file', file);

        const res = await fetch(`/api/browse/upload/${path}`, {
            method: 'POST',
            body: formData
        });

        if (res.ok) {
            alert('File uploaded successfully!');
            document.getElementById('fileInput').value = '';
            fetchAndRender(path);
        } else {
            const error = await res.text();
            alert('Upload failed: ' + error);
        }
    });

</script>
</body>
</html>
